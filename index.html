<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence App</title>
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.6.1.js"
        integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <!-- Datatables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>

    <!-- For Bootstrap Select -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <!--Range Slider -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>

    <!-- Icons -->
    <script src="https://kit.fontawesome.com/f3135b3376.js" crossorigin="anonymous"></script>

    <!-- Moment JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Custom CSS file -->
    <link href="styles.css" rel="stylesheet" />

    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>



<body>
    <!-- <div class="title">
        <h1>Regional Evidence</h1>
    </div> -->

    <div class="filters">
        <div class="title">
            <span><img id="logo" src="logo.png" style="height:25px;" />
                &nbsp;WFP Evidence Explorer
                <br>
                <hr>
            </span>
        </div>

        <form class="form">
            <div>
                <input type="text" id="searchInput" class="form-control" placeholder="&#xf002;&nbsp;&nbsp;Search">
            </div>
            <br>
            <div class="select">
                <select id="countrySelector" class="form-select selectpicker" data-width="100%" data-size="8"
                    name="country" data-dropdown>
                    <option value="">&#xf3c5;&nbsp;&nbsp;Country (All)</option>
                    <option id="afg" value="Afghanistan">&nbsp;&nbsp;Afghanistan</option>
                    <option value="Bangladesh">&nbsp;&nbsp;Bangladesh</option>
                    <option value="Bhutan">&nbsp;&nbsp;Bhutan</option>
                    <option value="Cambodia">&nbsp;&nbsp;Cambodia</option>
                    <option value="DPRK">&nbsp;&nbsp;DPRK</option>
                    <option value="India">&nbsp;&nbsp;India</option>
                    <option value="Indonesia">&nbsp;&nbsp;Indonesia</option>
                    <option value="Kyrgyz Republic">&nbsp;&nbsp;Kyrgyz Republic</option>
                    <option value="Laos">&nbsp;&nbsp;Laos</option>
                    <option value="Myanmar">&nbsp;&nbsp;Myanmar</option>
                    <option value="Nepal">&nbsp;&nbsp;Nepal</option>
                    <option value="Pacific">&nbsp;&nbsp;Pacific</option>
                    <option value="Pakistan">&nbsp;&nbsp;Pakistan</option>
                    <option value="Philippines">&nbsp;&nbsp;Philippines</option>
                    <option value="Sri Lanka">&nbsp;&nbsp;Sri Lanka</option>
                    <option value="Tajikistan">&nbsp;&nbsp;Tajikistan</option>
                    <option value="Timor-Leste">&nbsp;&nbsp;Timor-Leste</option>
                </select>
            </div>
            <br>
            <div class="select">
                <select id="categorySelector" class="form-select selectpicker" data-width="100%" data-size="8"
                    name="country" data-dropdown>
                    <option value="">&#xf550;&nbsp;&nbsp;Category (All)</option>
                    <option value="Situation Report">&nbsp;&nbsp;Situation Report</option>
                    <option value="Market/Price Monitoring">&nbsp;&nbsp;Market/Price Monitoring</option>
                    <option value="Analysis/Research">&nbsp;&nbsp;Analysis/Research</option>
                </select>
            </div>
            <br>
            <div id="rangeDropdown" class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    &#xf133;&nbsp;&nbsp;Date
                </button>
                <ul id="myRangeSlider" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <p class="js-input-from" id="min" class="minSlider" name="min" value="0">
                    <p style="width:100%;"><input type="text" class="js-range-slider" value="">
                    <p class="js-input-to" id="max" class="maxSlider" name="max" value="0">
                </ul>
            </div>
        </form>
        <br>
        <hr>
        <br>
        <div id="chartBox">
            <canvas id="myChart" style="width:100%;"></canvas>
        </div>
    </div>


    <div class="loading">Loading...</div>
    <div class="main">
        <table class="table mydatatable" id="mydatatable">
            <thead>
                <tr>
                    <th> </th>
                    <th> </th>
                    <th> </th>
                    <th> </th>
                </tr>
            </thead>
            <tbody id="myTable">
            </tbody>
        </table>
    </div>






    <script>

        const url = 'https://raw.githubusercontent.com/ctedja/regional_evidence/main/data.json';

        async function populate() {

            const response = await fetch(url);
            const evidenceData = await response.json();
            const countrySelector = document.getElementById('countrySelector')


            $(document).ready(function () {


                // Custom filtering function which will search data in column four between two values
                $.fn.dataTable.ext.search.push(
                    function (settings, data, dataIndex) {
                        var min = moment($('#min').val());
                        var max = moment($('#max').val());
                        var dateFilter = moment(data[4]) || 0;

                        if ((isNaN(min) && isNaN(max)) ||
                            (isNaN(min) && dateFilter <= max) ||
                            (min <= dateFilter && isNaN(max)) ||
                            (min <= dateFilter && dateFilter <= max)) {
                            return true;
                        }
                        return false;
                    }
                );

                // Pull in the Data Tables via jQuery
                var oTable = $('.mydatatable').DataTable({
                    ajax: "https://raw.githubusercontent.com/ctedja/regional_evidence/main/data.json",
                    columns: [
                        {
                            data: null,
                            render: function (data, type, row) {
                                return ('<br><a href="' + row.Link + '" target="_blank"><img class="tableThumbnail" src=' + row.Image + '><br><br>');
                            }
                        },
                        {
                            data: null,
                            render: function (data, type, row) {
                                var formattedDate = moment(row.Date).format('dddd, D MMMM YYYY');
                                return ('<span class="tableTitle"><br><a href="' + row.Link + '" target="_blank">' + row.Title + '</a><br></span>' +
                                    '<span class="tableCountry"><span>&nbsp;&nbsp;' + row.Country + '&nbsp;&nbsp;</span></span>&nbsp;&nbsp' +
                                    '<span class="tableCategory">&nbsp;&nbsp;' + row.Category + '&nbsp;&nbsp;</span>' +
                                    '<span class="tableDate"><span><br>&nbsp;&nbsp;<i class="far fa-calendar"></i>&nbsp;&nbsp;' + formattedDate + '</span></span>');
                            }
                        },
                        { data: "Country" },
                        { data: "Category" },
                        {
                            data: null,
                            render: function (data, type, row) {
                                var formattedDate = moment(row.Date).format('YYYY MM DD');
                                return (formattedDate)
                            }
                        },
                    ],
                    order: [[4]],
                    serverSide: false,
                    deferRender: true,
                    pageLength: 10,
                    paging: true,
                    pagingType: 'simple_numbers',
                    language: {
                        paginate: {
                            next: '>', // or '→'
                            previous: '<' // or '←' 
                        },
                        info: " _START_ to _END_ out of _TOTAL_ entries",
                        infoFiltered: ""
                    },
                    "dom": "<<t>ip>",
                    // We need those columns to be searchable, but not visible
                    "columnDefs": [{
                        targets: [2, 3, 4],
                        visible: false,
                        searchable: true,
                    }]
                });

                // Quick configuration - datatable clickable
                $('.mydatatable tbody').on('click', 'tr', function (data, type, row) {
                    window.open(oTable.row(this).data().Link, '_blank');
                });

                // Quick configuration - datatable scroll on paginate button
                oTable.on('page.dt', function () {
                    $('html, body').animate({
                        scrollTop: $(".dataTables_wrapper").offset().top
                    });
                });


                // Add the search filter to the side
                $('#searchInput').keyup(function () {
                    oTable.search($(this).val()).draw();
                });


                // Country Selector
                $('select#countrySelector').change(function () {
                    // Table
                    oTable.columns(2).search($(this).val()).draw();

                    // Chart
                    // var minDate = moment($('#min').val()).format('YY MM DD');
                    // var maxDate = moment($('#max').val()).format('YY MM DD');
                    // var countryValue = this.value

                    // const match = evidenceData.data.filter(countryArr => countryArr.Country === countryValue &&
                    //     (moment(countryArr.Date).format('YY MM DD') <= maxDate || isNaN(countryArr.Date)) &&
                    //     (moment(countryArr.Date).format('YY MM DD') >= minDate || isNaN(countryArr.Date)));

                    // if (match.length == 0) {
                    //     createChart(evidenceData.data, " ")
                    // } else if (match.length != 0 && maxDate == "") {
                    //     createChart(match, countryValue)
                    // } else {
                    //     createChart(match, " - Between Dates (" + countryValue + ")")
                    // }
                });


                $('select#categorySelector').change(function () {
                    oTable.columns(3).search($(this).val()).draw();
                });

                // Min/Max
                $('#max').keyup(function () {
                    oTable.columns(4).draw();
                });

                $('#min').keyup(function () {
                    oTable.columns(4).draw();
                });




                // buildTable(evidenceData)
                // Getting Range Slider Elements
                var $range = $(".js-range-slider"),
                    $inputFrom = $(".js-input-from"),
                    $inputTo = $(".js-input-to"),
                    instance,
                    min = moment("2017-01-01"),
                    max = moment(Date()),
                    from = moment("2017-01-01"),
                    to = moment(Date());

                $range.ionRangeSlider({
                    type: "double",
                    min: min,
                    max: max,
                    onStart: updateInputs,
                    onChange: updateInputs,
                    onFinish: updateInputs,
                    prettify: function (num) {
                        return moment(num).format('DD MMM YY');
                    }
                });
                instance = $range.data("ionRangeSlider");

                function updateInputs(data) {
                    from = data.from;
                    to = data.to;
                    $inputFrom.prop("value", from);
                    $inputTo.prop("value", to);

                    // Force keyup event to run min max event handler
                    $('#min').trigger('keyup');
                }

                $inputFrom.on("input", function () {
                    var val = $(this).prop("value");
                    // validate
                    if (val < min) {
                        val = min;
                    } else if (val > to) {
                        val = to;
                    }
                    instance.update({
                        from: val
                    });
                });

                $inputTo.on("input", function () {
                    var val = $(this).prop("value");
                    // validate
                    if (val < from) {
                        val = from;
                    } else if (val > max) {
                        val = max;
                    }
                    instance.update({
                        to: val
                    });
                });




                // Create our Chart
                function createChart(chartData, searchedName = "", animationTrigger = true) {

                    // Remove first
                    let chartStatus = Chart.getChart("myChart");
                    if (chartStatus != undefined) {
                        chartStatus.destroy();
                    }


                    var countryCount = chartData.map(function (d) { return d.Country; });


                    var monthCount = chartData.map(function (d) {
                        var date = moment(d.Date).startOf('month').format('MMM YY').toString();
                        return date;
                    });

                    // Count number for each unique value
                    function searchFunction(searchCriteria) {
                        var count = chartData.filter(function (d) {
                            if (moment(d.Date).startOf('month').format('MMM YY').toString() === searchCriteria) {
                                return true;
                            } else {
                                return false;
                            }
                        }).length;
                        return count;
                    }

                    // Get just the number of unique values, and then reverse the order
                    var uniqueMonth = [... new Set(monthCount)].filter(item => item != "Invalid date")
                    console.log(uniqueMonth)

                    // Use our searchFunction function to count the total number of values for each unique month/year
                    var values = uniqueMonth.map(searchFunction)


                    // Building the Chart
                    const data = {
                        labels: uniqueMonth,
                        datasets: [{
                            backgroundColor: '#cce5f2',
                            borderColor: '#cce5f2',
                            data: values,
                        }]
                    };

                    const config = {
                        type: 'bar',
                        data: data,
                        options: {
                            animation: animationTrigger,
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'WFP products ' + searchedName,
                                    align: 'start',
                                    padding: {
                                        top: 10,
                                        bottom: 30
                                    }
                                }
                            }
                        }
                    };

                    const myChart = new Chart(
                        document.getElementById('myChart'),
                        config
                    );
                }


                createChart(evidenceData.data)

                // Make the country selector work for the chart
                $('select#countrySelector').on('change', function (e) {
                    var minDate = moment($('#min').val()).format('YY MM DD');
                    var maxDate = moment($('#max').val()).format('YY MM DD');
                    var countryValue = this.value;
                    var categoryValue = $('select#categorySelector').val();

                    const match = evidenceData.data.filter(countryArr => countryArr.Country === countryValue &&
                        (countryArr.Category === categoryValue || isNaN(countryArr.Category)) &&
                        (moment(countryArr.Date).format('YY MM DD') <= maxDate || isNaN(countryArr.Date)) &&
                        (moment(countryArr.Date).format('YY MM DD') >= minDate || isNaN(countryArr.Date)));

                    if (match.length == 0) {
                        createChart(evidenceData.data, " ")

                    } else if (match.length != 0 && countryValue != "" && maxDate == "" && categoryValue == "") {
                        createChart(match, " (" + countryValue + ")")

                    } else if (match.length != 0 && countryValue == "" && maxDate == "" && categoryValue != "") {
                        createChart(match, " (" + categoryValue + ")")

                    } else if (match.length != 0 && countryValue != "" && maxDate == "" && categoryValue != "") {
                        createChart(match, " (" + countryValue + ", " + categoryValue + ")")

                    } else if (match.length != 0 && countryValue == "" && maxDate != "" && categoryValue == "") {
                        createChart(match, "- Between Dates")

                    } else if (match.length != 0 && countryValue != "" && maxDate != "" && categoryValue == "") {
                        createChart(match, "- Between Dates (" + countryValue + ")")

                    } else if (match.length != 0 && countryValue == "" && maxDate != "" && categoryValue != "") {
                        createChart(match, "- Between Dates (" + categoryValue + ")")

                    } else {
                        createChart(match, "- Between Dates (" + countryValue + ", " + categoryValue + ")")
                    }
                });


                $('select#categorySelector').on('change', function (e) {
                    var minDate = moment($('#min').val()).format('YY MM DD');
                    var maxDate = moment($('#max').val()).format('YY MM DD');
                    var categoryValue = this.value;
                    var countryValue = $('select#countrySelector').val();

                    const match = evidenceData.data.filter(countryArr => countryArr.Category === categoryValue &&
                        (countryArr.Country === countryValue || isNaN(countryArr.Country)) &&
                        (moment(countryArr.Date).format('YY MM DD') <= maxDate || isNaN(countryArr.Date)) &&
                        (moment(countryArr.Date).format('YY MM DD') >= minDate || isNaN(countryArr.Date)));

                    if (match.length == 0) {
                        createChart(evidenceData.data, " ")

                    } else if (match.length != 0 && countryValue != "" && maxDate == "" && categoryValue == "") {
                        createChart(match, " (" + countryValue + ")")

                    } else if (match.length != 0 && countryValue == "" && maxDate == "" && categoryValue != "") {
                        createChart(match, " (" + categoryValue + ")")

                    } else if (match.length != 0 && countryValue != "" && maxDate == "" && categoryValue != "") {
                        createChart(match, " (" + countryValue + ", " + categoryValue + ")")

                    } else if (match.length != 0 && countryValue == "" && maxDate != "" && categoryValue == "") {
                        createChart(match, "- Between Dates")

                    } else if (match.length != 0 && countryValue != "" && maxDate != "" && categoryValue == "") {
                        createChart(match, "- Between Dates (" + countryValue + ")")

                    } else if (match.length != 0 && countryValue == "" && maxDate != "" && categoryValue != "") {
                        createChart(match, "- Between Dates (" + categoryValue + ")")

                    } else {
                        createChart(match, "- Between Dates (" + countryValue + ", " + categoryValue + ")")
                    }
                });


                // Make the Range Slider
                $("#myRangeSlider").on("mouseup", function () {
                    var minDate = moment($('#min').val()).format('YY MM DD');
                    var maxDate = moment($('#max').val()).format('YY MM DD');
                    var countryValue = $('select#countrySelector').val();
                    var categoryValue = $('select#categorySelector').val();

                    const match = evidenceData.data.filter(countryArr =>
                        moment(countryArr.Date).format('YY MM DD') <= maxDate &&
                        moment(countryArr.Date).format('YY MM DD') >= minDate &&
                        (countryArr.Country === countryValue || isNaN(countryArr.Country)) &&
                        (countryArr.Category === categoryValue || isNaN(countryArr.Category)));

                    // This doesn't work
                    var dateText = document.getElementById('dropdownMenuButton')

                    if (match.length == 0) {
                        dateText.innerHTML = 'Date'
                        $("#dropdownMenuButton").removeClass('dropdownAddClass')
                    } else {
                        dateText.innerHTML = (moment(minDate, 'YY MM DD').format('MMM YYYY') + ' to ' + moment(maxDate, 'YY MM DD').format('MMM YYYY'))
                        $("#dropdownMenuButton").addClass('dropdownAddClass')
                    }

                    if (match.length == 0) {
                        createChart(evidenceData, " ")
                    } else if (match.length != 0 && countryValue == "" && categoryValue == "") {
                        createChart(match, " - Between Dates")
                    } else if (match.length != 0 && countryValue == "" && categoryValue != "") {
                        createChart(match, " - Between Dates (" + categoryValue + ")")
                    } else if (match.length != 0 && countryValue != "" && categoryValue == "") {
                        createChart(match, " - Between Dates (" + countryValue + ")")
                    } else {
                        createChart(match, " - Between Dates (" + countryValue + ", " + categoryValue + ")")
                    }
                });

                // Add background-color class when the user has typed something in 
                $('#searchInput').focus(function () {
                    $(this).addClass("dropdownAddClass");
                });
                $('#searchInput').blur(function () {
                    if (this.value === '') { $(this).removeClass("dropdownAddClass"); }
                });



                // const filterHandlers = new Map([
                //     [
                //         'budget',
                //         (val, [min, max]) => val >= min && val <= max
                //     ],
                //     [
                //         'categories',
                //         (current, categories) => current.some( // some - at least one, every - all of them 
                //             (c) => categories.includes(c)
                //         )
                //     ],
                //     []
                // ]);

                // const applyFilters = (arr, filters) => {
                //     const filterKeys = Object.keys(filters);

                //     return arr.filter(o => filterKeys.every((key) => {
                //         const handler = filterHandlers.get(key);

                //         return !handler || handler(o[key], filters[key]);
                //     }));
                // }

                // const data = [{ "budget": "220", "categories": ["party", "school"] }, { "budget": "450", "categories": ["self"] }, { "budget": "600", "categories": ["dev", "work"] }];

                // const filters = { "budget": ["200", "500"], "categories": ["party"] };

                // const result = applyFilters(data, filters);
            })



        }

        populate();

    </script>

</body>

</html>