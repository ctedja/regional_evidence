<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence App</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"
        integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <!-- Datatables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>

    <!-- For Bootstrap Select -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <!--Range Slider -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>

    <!-- Icons -->
    <script src="https://kit.fontawesome.com/f3135b3376.js" crossorigin="anonymous"></script>

    <!-- Moment JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Custom CSS file -->
    <link href="styles.css" rel="stylesheet" />

    <!-- ChartJS -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->

</head>



<body>
    <!-- Left column -->
    <div class="left-column">
        <div class="title">
            <h1>RBB Evidence Explorer</h1>
            <h2>AN OVERVIEW OF EXTERNAL PUBLICATIONS</h2>
            <br>
            <hr>
        </div>

        <form class="form">
            <!-- Filter #1 is a Search Bar -->
            <div>
                <input type="text" id="searchInput" class="form-control" placeholder="&#xf002;&nbsp;&nbsp;Search">
            </div>
            <br>

            <!-- Filter #2 is a Country Selector -->
            <div class="select">
                <select id="countrySelector" class="form-select selectpicker" data-width="100%" data-size="8"
                    name="country" data-dropdown>
                    <option value="">&#xf3c5;&nbsp;&nbsp;Country (All)</option>
                    <option id="afg" value="Afghanistan">&nbsp;&nbsp;Afghanistan</option>
                    <option value="Bangladesh">&nbsp;&nbsp;Bangladesh</option>
                    <option value="Bhutan">&nbsp;&nbsp;Bhutan</option>
                    <option value="Cambodia">&nbsp;&nbsp;Cambodia</option>
                    <option value="DPRK">&nbsp;&nbsp;DPRK</option>
                    <option value="India">&nbsp;&nbsp;India</option>
                    <option value="Indonesia">&nbsp;&nbsp;Indonesia</option>
                    <option value="Kyrgyzstan">&nbsp;&nbsp;Kyrgyz Republic</option>
                    <option value="Lao People's Democratic Republic">&nbsp;&nbsp;Laos</option>
                    <option value="Myanmar">&nbsp;&nbsp;Myanmar</option>
                    <option value="Nepal">&nbsp;&nbsp;Nepal</option>
                    <option value="Pacific">&nbsp;&nbsp;Pacific</option>
                    <option value="Pakistan">&nbsp;&nbsp;Pakistan</option>
                    <option value="Philippines">&nbsp;&nbsp;Philippines</option>
                    <option id="afg" value="Asia-Pacific">&nbsp;&nbsp;Regional</option>
                    <option value="Sri Lanka">&nbsp;&nbsp;Sri Lanka</option>
                    <option value="Tajikistan">&nbsp;&nbsp;Tajikistan</option>
                    <option value="Timor-Leste">&nbsp;&nbsp;Timor-Leste</option>
                </select>
            </div>
            <br>

            <!-- Filter #3 is a Category Selector Bar -->
            <div class="select">
                <select id="categorySelector" class="form-select selectpicker" data-width="100%" data-size="8"
                    name="country" data-dropdown>
                    <option value="">&#xf550;&nbsp;&nbsp;Category (All)</option>
                    <option value="Analysis/Research">&nbsp;&nbsp;Analysis/Research</option>
                    <option value="Annual Country Report">&nbsp;&nbsp;Annual Country Report</option>
                    <option value="Assessments (Food Security and Nutrition)">&nbsp;&nbsp;Assessments (Food Security and
                        Nutrition)</option>
                    <option value="Country Brief">&nbsp;&nbsp;Country Brief</option>
                    <option value="Dashboards/Maps/Infographics">&nbsp;&nbsp;Dashboards/Maps/Infographics</option>
                    <option value="Evaluation and Lessons Learned">&nbsp;&nbsp;Evaluation and Lessons Learned</option>
                    <option value="Manual and Guideline">&nbsp;&nbsp;Manual and Guideline</option>
                    <option value="Market/Price Monitoring">&nbsp;&nbsp;Market/Price Monitoring</option>
                    <option value="Other">&nbsp;&nbsp;Other</option>
                    <!-- <option value="Response Plans/Appeals">&nbsp;&nbsp;Response Plans/Appeals</option> -->
                    <option value="Situation Report">&nbsp;&nbsp;Situation Report (External)</option>
                    <option value="Stories/Articles">&nbsp;&nbsp;Stories/Articles</option>
                </select>
            </div>
            <br>

            <!-- Filter #4 is a Data Slider -->
            <div id="rangeDropdown" class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    &#xf133;&nbsp;&nbsp;Date
                </button>
                <ul id="myRangeSlider" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <p class="js-input-from" id="min" class="minSlider" name="min" value="0">
                    <p style="width:100%;"><input type="text" class="js-range-slider" value="">
                    <p class="js-input-to" id="max" class="maxSlider" name="max" value="0">
                </ul>
            </div>

        </form>
        <br>
        <hr>
        <br>

        <!-- Time Series -->
        <!-- <div id="chartBox">
            <canvas id="myChart" style="width:100%;"></canvas>
        </div> -->
    </div>


    <!-- Main section (Right side) -->
    <div class="main">
        <div class="loading">Loading...</div>

        <!-- Empty table -->
        <table class="table mydatatable" id="mydatatable">
            <thead>
                <tr>
                    <th> </th>
                    <th> </th>
                    <th> </th>
                    <th> </th>
                </tr>
            </thead>
            <tbody id="myTable">
            </tbody>
        </table>

    </div>






    <script>

        const url = 'https://raw.githubusercontent.com/ctedja/regional_evidence/main/data.json';

        async function populate() {

            const response = await fetch(url);
            const evidenceData = await response.json();
            const countrySelector = document.getElementById('countrySelector')


            $(document).ready(function () {


                // Pull in the Data Tables via jQuery
                var oTable = $('.mydatatable').DataTable({
                    data: evidenceData.data,
                    columns: [
                        // Column 0. Render the thumbnail side of the row. 
                        {
                            data: null,
                            render: function (data, type, row) {
                                return ('<br><img class="tableThumbnail" src=' + row.Image + '><br><br>');
                            }
                        },
                        // Column 1. Render the text details of the row
                        {
                            data: null,
                            render: function (data, type, row) {
                                var formattedDate = moment(row.Date).format('dddd, D MMMM YYYY');
                                return ('<span class="tableTitle"><br>' + row.Title + '<br></span>' +
                                    '<span class="tableCountry"><span>&nbsp;&nbsp;' + row.Country + '&nbsp;&nbsp;</span></span>&nbsp;&nbsp' +
                                    '<span class="tableCategory">&nbsp;&nbsp;' + row.Category + '&nbsp;&nbsp;</span>' +
                                    '<span class="tableDate"><span><br>&nbsp;&nbsp;<i class="far fa-calendar"></i>&nbsp;&nbsp;' + formattedDate + '</span></span>');
                            }
                        },
                        // Column 2. Add the country detail for filtering, though  this will be hidden.
                        { data: "Country" },
                        // Column 3. Add the Category detail for filtering, though  this will be hidden.
                        { data: "Category" },
                        // Column 4. Add the Date Detail for filtering, though this will be hidden.
                        {
                            data: null,
                            render: function (data, type, row) {
                                var formattedDate = moment(row.Date).format('YYYY MM DD');
                                return (formattedDate)
                            }
                        },
                    ],
                    order: [[4]],
                    serverSide: false,
                    deferRender: true,
                    pageLength: 10,
                    paging: true,
                    pagingType: 'simple_numbers',
                    language: {
                        paginate: {
                            next: '>', // or '→'
                            previous: '<' // or '←' 
                        },
                        info: " _START_ to _END_ out of _TOTAL_ entries",
                        infoFiltered: ""
                    },
                    "dom": "<<t>ip>",
                    // We need those columns to be searchable, but not visible
                    "columnDefs": [{
                        targets: [2, 3, 4],
                        visible: false,
                        searchable: true,
                    }],
                });

                // Quick configuration - make datatable clickable
                oTable.on('click', 'tr', function (data, type, row) {
                    window.open(oTable.row(this).data().Link, '_blank');
                });

                // Quick configuration - make datatable scroll on paginate button
                oTable.on('page.dt', function () {
                    $('html, body').animate({
                        scrollTop: $(".dataTables_wrapper").offset().top
                    });
                });

                // Date filter: Enable a search function which will search data in column four between two values
                $.fn.dataTable.ext.search.push(
                    function (settings, data, dataIndex) {
                        var min = moment($('#min').val());
                        var max = moment($('#max').val());
                        var dateFilter = moment(data[4]) || 0;

                        if ((isNaN(min) && isNaN(max)) ||
                            (isNaN(min) && dateFilter <= max) ||
                            (min <= dateFilter && isNaN(max)) ||
                            (min <= dateFilter && dateFilter <= max)) {
                            return true;
                        }
                        return false;
                    }
                );

                // Search filter: Enable the search filter
                $('#searchInput').on('keyup', function () {
                    oTable.search($(this).val()).draw();
                });

                // Add background-color class when the user has typed something in 
                $('#searchInput').on('focus', function () {
                    $(this).addClass("dropdownAddClass");
                });

                $('#searchInput').on('blur', function () {
                    if (this.value === '') { $(this).removeClass("dropdownAddClass"); }
                });


                // Country selector: Enable the country selector
                $('select#countrySelector').change(function () {
                    // Table
                    oTable.columns(2).search($(this).val()).draw();
                });

                // Country selector: Enable the country selector
                $('select#categorySelector').change(function () {
                    oTable.columns(3).search($(this).val()).draw();
                });

                // Enabel the range slider
                $('#max').keyup(function () {
                    oTable.columns(4).draw();
                });

                $('#min').keyup(function () {
                    oTable.columns(4).draw();
                });

                // Getting Range Slider Elements
                var $range = $(".js-range-slider"),
                    $inputFrom = $(".js-input-from"),
                    $inputTo = $(".js-input-to"),
                    instance,
                    min = moment("2017-01-01"),
                    max = moment(Date()),
                    from = moment("2017-01-01"),
                    to = moment(Date());

                $range.ionRangeSlider({
                    type: "double",
                    min: min,
                    max: max,
                    onStart: updateInputs,
                    onChange: updateInputs,
                    onFinish: updateInputs,
                    prettify: function (num) {
                        return moment(num).format('DD MMM YY');
                    }
                });
                instance = $range.data("ionRangeSlider");

                function updateInputs(data) {
                    from = data.from;
                    to = data.to;
                    $inputFrom.prop("value", from);
                    $inputTo.prop("value", to);

                    // Force keyup event to run min max event handler
                    $('#min').trigger('keyup');
                }

                $inputFrom.on("input", function () {
                    var val = $(this).prop("value");
                    // validate
                    if (val < min) {
                        val = min;
                    } else if (val > to) {
                        val = to;
                    }
                    instance.update({
                        from: val
                    });
                });

                $inputTo.on("input", function () {
                    var val = $(this).prop("value");
                    // validate
                    if (val < from) {
                        val = from;
                    } else if (val > max) {
                        val = max;
                    }
                    instance.update({
                        to: val
                    });
                });

            })

        }

        populate();

    </script>

</body>

</html>